Import('env')

import os

dox = env.Doxygen("#/doc/html/index.html", "#/doc/doxygen/doxygen.conf")

docdir = env.GetInstallDirectory('docdir', 'doxygen')

# Install all files from 'dox' directory into the 'docdir' directory (cannot
# use env.InstallAs() right now, due to scons bug #1751)
env.Command(Dir(env.subst(docdir)), dox,
            "install -d $TARGET && install ${SOURCE.dir}/* $TARGET")
env.Alias('docinstall', docdir)

# Generate doxygen.conf from doxygen.conf.in
def generate_doxygen(target, source, env):
    infile = file(source[0].path, 'r')
    outfile = file(target[0].path, 'w')
    print >> outfile, "# Auto-generated by SConscript; do NOT edit directly!"
    print >> outfile, "# Edit %s instead\n" % source[0].path
    for line in infile:
        if '@ALL_MODULES@' in line:
            # Expand out ALL_MODULES to a list of all modules, one per line
            for mod in env['IMP_MODULES_ALL']:
                outfile.write(line.replace('@ALL_MODULES@', mod))
        elif '@IMP_HAS_DOT@' in line:
            if os.system('dot -V > /dev/null') == 0:
                outfile.write(line.replace('@IMP_HAS_DOT@', 'YES'))
            else:
                outfile.write(line.replace('@IMP_HAS_DOT@', 'NO'))
        elif not line.startswith('#'):
            outfile.write(line)
    infile.close()
    outfile.close()

env.Append(BUILDERS = {'GenerateDoxygen': Builder(action=generate_doxygen)})
dox=env.GenerateDoxygen("doxygen.conf", "doxygen.conf.in")
env.AlwaysBuild("doxygen.conf")
Clean(dox, Glob("#/doc/html/*"))
examples = env.MakeExamples("#/doc/doxygen/.examples/examples.dox", None)
Return('dox', 'examples')
