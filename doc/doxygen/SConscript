Import('env')

import os.path

dox = env.Doxygen("html/index.html", "doxygen.conf")

docdir = os.path.join(env['docdir'], 'doxygen')

# Install all files from 'dox' directory into the 'docdir' directory (cannot
# use env.InstallAs() right now, due to scons bug #1751)
env.Command(Dir(env.subst(docdir)), dox,
            "install -d $TARGET && install ${SOURCE.dir}/* $TARGET")

# Generate doxygen.conf from doxygen.conf.in
def generate_doxygen(target, source, env):
    infile = file(source[0].path, 'r')
    outfile = file(target[0].path, 'w')
    print >> outfile, "# Auto-generated by SConscript; do NOT edit directly!"
    print >> outfile, "# Edit %s instead\n" % source[0].path
    for line in infile:
        if '@ALL_MODULES@' in line:
            # Expand out ALL_MODULES to a list of all modules, one per line
            for mod in env['IMP_MODULES_ALL']:
                outfile.write(line.replace('@ALL_MODULES@', mod))
        elif not line.startswith('#'):
            outfile.write(line)
    infile.close()
    outfile.close()

env.Append(BUILDERS = {'GenerateDoxygen': Builder(action=generate_doxygen)})
env.GenerateDoxygen("doxygen.conf", "doxygen.conf.in")

examples = env.MakeExamples(".examples/examples.dox", None)
env.AlwaysBuild(examples)
