/**
 *  \file internal/singleton_helpers.h    \brief A container for particles.
 *
 *  This file is generated by a script (core/tools/make-container).
 *  Do not edit directly.
 *
 *  Copyright 2007-9 Sali Lab. All rights reserved.
 */

#ifndef IMPCORE_INTERNAL_SINGLETON_HELPERS_H
#define IMPCORE_INTERNAL_SINGLETON_HELPERS_H

#include "../config.h"
#include "../ListSingletonContainer.h"
#include <algorithm>

IMPCORE_BEGIN_INTERNAL_NAMESPACE

template <class OC, class BC>
void update_list(OC &old, ParticlesTemp &cur,
                 BC *th) {
  if (th->get_is_added_or_removed_container()) {
    swap(old, cur);
  } else {
    std::sort(cur.begin(), cur.end());
    ParticlesTemp added, removed;
    std::set_difference(cur.begin(), cur.end(),
                        old.begin(), old.end(),
                        std::back_inserter(added));
    std::set_difference(old.begin(), old.end(),
                        cur.begin(), cur.end(),
                        std::back_inserter(removed));
    swap(old, cur);
    dynamic_cast<ListSingletonContainer*>
      (th->get_added_singletons_container())->set_particles(added);
    dynamic_cast<ListSingletonContainer*>
      (th->get_removed_singletons_container())->set_particles(removed);
  }
}


template <class OC, class BC>
void add_to_list(OC &old, ParticlesTemp &cur,
                 BC *th) {
  std::sort(cur.begin(), cur.end());
  ParticlesTemp added;
  std::set_difference(cur.begin(), cur.end(),
                      old.begin(), old.end(),
                      std::back_inserter(added));
  unsigned int osz= old.size();
  old.insert(old.end(), added.begin(), added.end());
  std::inplace_merge(old.begin(), old.begin()+osz, old.end());
  if (!th->get_is_added_or_removed_container()) {
   dynamic_cast<ListSingletonContainer*>
     (th->get_added_singletons_container())->set_particles(added);
  }
}


IMPCORE_END_INTERNAL_NAMESPACE

#define IMP_LISTLIKE_SINGLETON_CONTAINER_DEF(Name)                      \
  ParticlesTemp Name::get_particles() const {                         \
    return data_;                                                       \
  }                                                                     \
  Particle* Name::get_particle(unsigned int i) const {             \
    return data_[i];                                                    \
  }                                                                     \
  void Name::apply(const SingletonModifier *sm) {                       \
    sm->apply(data_);                                                   \
  }                                                                     \
  void Name::apply(const SingletonModifier *sm,                         \
                   DerivativeAccumulator &da) {                         \
    sm->apply(data_, da);                                               \
  }                                                                     \
  double Name::evaluate(const SingletonScore *s,                        \
                        DerivativeAccumulator *da) const {              \
    return s->evaluate(data_, da);                                      \
  }                                                                     \
  double Name::evaluate_change(const SingletonScore *s,                 \
                               DerivativeAccumulator *da) const {       \
    return s->evaluate_change(data_, da);                               \
  }                                                                     \
  double Name::evaluate_prechange(const SingletonScore *s,              \
                                  DerivativeAccumulator *da) const {    \
    return s->evaluate_prechange(data_, da);                            \
  }                                                                     \
  unsigned int Name::get_number_of_particles() const {                 \
    return data_.size();                                                \
  }                                                                     \
  bool                                                                  \
  Name::get_contains_particle(Particle* vt) const {                 \
    IMP_CHECK_OBJECT(this);                                             \
    return std::binary_search(data_.begin(), data_.end(), vt);          \
  }


#endif  /* IMPCORE_INTERNAL_SINGLETON_HELPERS_H */
